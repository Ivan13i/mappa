<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Dinamica con Dati Meteo</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/ol@latest/dist/ol.js"></script>
    <style>
        #map { width: 100%; height: 80vh; }
        #menu-container {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 5;
        }
        .info-panel {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 5px;
            z-index: 6;
            width: 300px;
            display: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        .info-panel button {
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .info-panel img {
            width: 100%;
            height: auto;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .info-panel button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div id="menu-container">
        <label for="parameter-select">Seleziona Parametro: </label>
        <select id="parameter-select">
            <option value="Temperatura">Temperatura</option>
            <option value="Vento">Vento</option>
            <option value="Precipitazioni">Precipitazioni</option>
        </select>
    </div>

    <div id="map"></div>

    <div id="info-panel" class="info-panel">
        <h3>Dettagli della Stazione</h3>
        <div id="info-content"></div>
        <button onclick="closeInfoPanel()">Chiudi</button>
    </div>

    <script>
        const mapboxToken = 'pk.eyJ1IjoiaXZhbjEzIiwiYSI6ImNsem1tcWIyeTBmeXcya3I0Mm9iMnduZ2kifQ.ohKNs_jXuoP88ApihpaxXA';

        var map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: `https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=${mapboxToken}`,
                        maxZoom: 19
                    })
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([13.5, 37.6]),  // Centro in Sicilia
                zoom: 8
            })
        });

        var markerLayer = new ol.layer.Vector({
            source: new ol.source.Vector()
        });

        map.addLayer(markerLayer);

        // Funzione per caricare dinamicamente tutte le stazioni dai file JSON
        function loadStationsData() {
            // Qui inseriamo i link ai file JSON delle stazioni
            const stationsFiles = [
                "stations/alia_chianchitelle.json"
                "alia_viapalermo.json"
                // Aggiungi altri file JSON delle stazioni, es. "stations/stazione2.json", "stations/stazione3.json", ...
            ];

            stationsFiles.forEach(stationFile => {
                fetch(stationFile)
                    .then(response => response.json())
                    .then(station => {
                        const { Nome, Latitudine, Longitudine, UrlDati, LinkSito, Immagine } = station;

                        // Carica i dati meteo da UrlDati tramite il proxy
                        fetchWeatherData(UrlDati).then(data => {
                            // Verifica se i dati sono disponibili
                            if (!data) return;

                            // Crea il marker per la stazione
                            const coordinate = ol.proj.fromLonLat([Longitudine, Latitudine]);

                            const marker = new ol.Feature({
                                geometry: new ol.geom.Point(coordinate),
                                name: Nome,
                                value: parseFloat(data["Temperatura"]),
                                link: LinkSito,
                                image: Immagine,
                                data: data
                            });

                            marker.setStyle(new ol.style.Style({
                                image: new ol.style.Circle({
                                    radius: 15,
                                    fill: new ol.style.Fill({ color: getTemperatureColor(parseFloat(data["Temperatura"])) }),
                                    stroke: new ol.style.Stroke({ color: '#000', width: 2 })
                                }),
                                text: new ol.style.Text({
                                    text: data["Temperatura"] ? data["Temperatura"].split(" ")[0] : "N/A",
                                    font: 'bold 16px Arial',
                                    fill: new ol.style.Fill({ color: '#fff' }),
                                    stroke: new ol.style.Stroke({ color: '#000', width: 2 })
                                })
                            }));

                            markerLayer.getSource().addFeature(marker);
                        });
                    })
                    .catch(error => console.error('Errore nel caricare i dati per la stazione:', error));
            });
        }

        function fetchWeatherData(url) {
            const proxyUrl = "https://cors-anywhere.herokuapp.com/";
            const fullUrl = proxyUrl + url;
            
            return fetch(fullUrl)
                .then(response => response.json())
                .catch(error => {
                    console.error("Errore nel recupero dei dati meteo:", error);
                    return null;
                });
        }

        function getTemperatureColor(temperature) {
            if (temperature <= 5) return '#1e90ff';
            if (temperature <= 15) return '#ffcc00';
            if (temperature <= 25) return '#ff6347';
            return '#ff0000';
        }

        map.on('click', function(event) {
            map.forEachFeatureAtPixel(event.pixel, function(feature) {
                const data = feature.get('data');
                const name = feature.get('name');
                const link = feature.get('link');
                const image = feature.get('image');
                const coordinate = feature.getGeometry().getCoordinates();
                if (data && name) {
                    openInfoPanel(coordinate, name, data, link, image);
                }
            });
        });

        function openInfoPanel(coordinate, name, data, link, image) {
            const panel = document.getElementById("info-panel");
            const content = document.getElementById("info-content");

            const pixel = map.getPixelFromCoordinate(coordinate); // Converte coordinate in pixel
            panel.style.left = `${pixel[0] + 15}px`;
            panel.style.top = `${pixel[1] - 100}px`;

            content.innerHTML = `
                <strong>${name}</strong><br>
                <p>Temperatura: ${data["Temperatura"] || "N/A"}</p>
                <p>Temperatura Max: ${data["Temperatura Max"] || "N/A"}</p>
                <p>Temperatura Min: ${data["Temperatura Min"] || "N/A"}</p>
                <p>Umidità: ${data["Umidità"] || "N/A"}</p>
                <p>Vento: ${data["Vento"] || "N/A"}</p>
                <p>Precipitazioni: ${data["Rate Rain"] || "N/A"}</p>
                <p><a href="${link}" target="_blank">Vai al sito della stazione</a></p>
                <img src="${image}" alt="Immagine Stazione">
            `;

            panel.style.display = "block";
        }

        function closeInfoPanel() {
            document.getElementById("info-panel").style.display = "none";
        }

        loadStationsData();  // Carica i dati delle stazioni
    </script>
</body>
</html>

