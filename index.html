<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Dinamica con Dati Meteo</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/ol@latest/dist/ol.js"></script>
    <style>
        #map { width: 100%; height: 80vh; }
        #menu-container {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 5;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        .info-panel {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 5px;
            z-index: 6;
            width: 300px;
            display: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        .info-panel button {
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .info-panel img {
            width: 100%;
            height: auto;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .info-panel button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div id="menu-container">
        <label for="parameter-select">Seleziona Parametro: </label>
        <select id="parameter-select">
            <option value="Temperatura">Temperatura</option>
            <option value="Vento">Vento</option>
            <option value="Precipitazioni">Precipitazioni</option>
        </select>
    </div>

    <div id="map"></div>

    <div id="info-panel" class="info-panel">
        <h3>Dettagli della Stazione</h3>
        <div id="info-content"></div>
        <button onclick="closeInfoPanel()">Chiudi</button>
    </div>

    <script>
        const mapboxToken = 'pk.eyJ1IjoiaXZhbjEzIiwiYSI6ImNsem1tcWIyeTBmeXcya3I0Mm9iMnduZ2kifQ.ohKNs_jXuoP88ApihpaxXA';

        // Creazione della mappa con OpenLayers
        const map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: `https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=${mapboxToken}`,
                        maxZoom: 19
                    })
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([13.5, 37.6]),  // Centro in Sicilia
                zoom: 8
            })
        });

        // Livello per i marker
        const markerLayer = new ol.layer.Vector({
            source: new ol.source.Vector()
        });
        map.addLayer(markerLayer);

        // Funzione per caricare i dati delle stazioni
        function loadStationsData() {
            const stationsFiles = [
                "https://meteofontanamurata.altervista.org/scraping/tutte/aliachianchitelle.php",
                "https://meteofontanamurata.altervista.org/scraping/tutte/aliaviapalermo.php"
            ];

            stationsFiles.forEach(stationFile => {
                const proxyUrl = `https://meteofontanamurata.altervista.org/scraping/tutte/proxy.php?url=${encodeURIComponent(stationFile)}`;
                fetch(proxyUrl)
                    .then(response => response.json())
                    .then(station => {
                        if (!station) {
                            console.error('Dati stazione non validi:', stationFile);
                            return;
                        }
                        createMarker(station);
                    })
                    .catch(error => console.error('Errore nel caricamento della stazione:', error));
            });
        }

        // Funzione per creare un marker
        function createMarker(station) {
            const { Nome, Latitudine, Longitudine, UrlDati, LinkSito, Immagine } = station;

            // Controllo validità dati
            if (!Nome || !Latitudine || !Longitudine || !UrlDati || !LinkSito || !Immagine) {
                console.error('Dati incompleti per la stazione:', station);
                return;
            }

            // Caricamento dati meteo
            fetchWeatherData(UrlDati).then(data => {
                if (!data) return;

                const coordinate = ol.proj.fromLonLat([Longitudine, Latitudine]);

                const marker = new ol.Feature({
                    geometry: new ol.geom.Point(coordinate),
                    name: Nome,
                    link: LinkSito,
                    image: Immagine,
                    data: data
                });

                marker.setStyle(new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 15,
                        fill: new ol.style.Fill({ color: getTemperatureColor(data.Temperatura) }),
                        stroke: new ol.style.Stroke({ color: '#000', width: 2 })
                    }),
                    text: new ol.style.Text({
                        text: `${data.Temperatura || "N/A"}°C`,
                        font: 'bold 14px Arial',
                        fill: new ol.style.Fill({ color: '#fff' }),
                        stroke: new ol.style.Stroke({ color: '#000', width: 2 })
                    })
                }));

                markerLayer.getSource().addFeature(marker);
            });
        }

        // Recupera i dati meteo dal file JSON
        function fetchWeatherData(url) {
            const proxyUrl = `https://meteofontanamurata.altervista.org/scraping/tutte/proxy.php?url=${encodeURIComponent(url)}`;
            return fetch(proxyUrl)
                .then(response => response.json())
                .catch(error => {
                    console.error('Errore nel recupero dei dati meteo:', error);
                    return null;
                });
        }

        // Colore in base alla temperatura
        function getTemperatureColor(temperature) {
            if (temperature <= -15) return '#800080'; // Viola
            if (temperature <= -1) return '#00FFFF'; // Celeste
            if (temperature <= 6) return '#008000'; // Verde
            if (temperature <= 21) return '#FFFF00'; // Giallo
            if (temperature <= 26) return '#FFA500'; // Arancione
            if (temperature <= 33) return '#FF0000'; // Rosso
            return '#8B0000'; // Rosso scuro
        }

        // Mostra pannello informazioni
        function openInfoPanel(coordinate, name, data, link, image) {
            const panel = document.getElementById("info-panel");
            const content = document.getElementById("info-content");

            const pixel = map.getPixelFromCoordinate(coordinate); // Converti coordinate in pixel
            panel.style.left = `${pixel[0] + 15}px`;
            panel.style.top = `${pixel[1] - 100}px`;

            content.innerHTML = `
                <strong>${name}</strong><br>
                <p>Temperatura: ${data.Temperatura || "N/A"}</p>
                <p>Umidità: ${data.Umidità || "N/A"}</p>
                <p>Vento: ${data.Vento || "N/A"}</p>
                <p>Precipitazioni: ${data["Rate Rain"] || "N/A"}</p>
                <p><a href="${link}" target="_blank">Vai al sito della stazione</a></p>
                <img src="${image}" alt="Immagine Stazione">
            `;

            panel.style.display = "block";
        }

        function closeInfoPanel() {
            document.getElementById("info-panel").style.display = "none";
        }

        // Evento di click sui marker
        map.on('click', function(event) {
            map.forEachFeatureAtPixel(event.pixel, function(feature) {
                const data = feature.get('data');
                const name = feature.get('name');
                const link = feature.get('link');
                const image = feature.get('image');
                const coordinate = feature.getGeometry().getCoordinates();

                if (data && name) {
                    openInfoPanel(coordinate, name, data, link, image);
                }
            });
        });

        // Caricamento delle stazioni
        loadStationsData();
    </script>
</body>
</html>

